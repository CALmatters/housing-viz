<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <!-- cartodb.js comes with Leaflet @0.7 and jQuery -->
  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
  <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
  <!-- This script makes it easy to use Stamen basemaps   -->
  <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>

  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    #map {
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    // necessary for making AJAX calls on Blockbuilder.org as of 2016-11-02
    jQuery.support.cors = true;
    // create a new map centered on the U.S.
    var map = L.map('map').setView([39.69, -99.185], 5);
    // create a tile layer for our toner basemap
    var tonerLayer = new L.StamenTileLayer("watercolor");
		// // add the tile layer to the map
		map.addLayer(tonerLayer);
    // // Set up our GeoJSON layer, add it to the map, but don't add data just yet
    var tornadoLayer = L.geoJson(null).addTo(map);
    // // Here are two different ways to load data from a Carto table
    // /*
    //  * Method 1: using jQuery's getJSON method
    // */
    // // the endpoint to make SQL calls to
    // var endpoint = "https://stamen-builder.carto.com/api/v2/sql?format=GeoJSON&q=";
    // // sample query for our Tornado table
    // var query = "SELECT * FROM tornado WHERE \"timestamp\" >= '2012-01-01' and \"timestamp\" < '2013-01-01'";
    // // using getJSON we concatenate these two strings to create the target URL
    // var url = endpoint + query;
    // $.getJSON(url, function(data) {
    //   console.log(data);
    //   // add the tornado data to our tornadoLayer
    //   // tornadoLayer.addData(data);
    // })
    // .fail(function( jqxhr, textStatus, error ) {
    //   var err = textStatus + ", " + error;
    //   console.log( "Request Failed: " + err );
    // });
    // /*
    //  * Method 2: using the cartodb.js SQL object
    // */
    // // set up the SQL object by giving it your Carto account name
    // // if you want to write to your table you'll also need to pass an API Key,
    // // eg: `api_key: 'someReallylongString'`
    // var sql = new cartodb.SQL({ user: 'mlevin' });
    // var query = "SELECT * FROM homelessness_totals WHERE (total_homeless_2009 >= 176 AND total_homeless_2017 < 10956.745762711864)";
    // // // execute the query, first param is the SQL query string,
    // // // second can be variables to be interpretted by the query,
    // // // third are additional options
    // sql.execute(query, null, { format: 'geojson' })
    // .done(function(data) {
    //   console.log(data);
    //   // add the tornado data to our tornadoLayer
    //   tornadoLayer.addData(data);
    // });

    var sql = new cartodb.SQL({ user: 'cartodb_user' });
sql.execute("SELECT * FROM homelessness_totals WHERE (total_homeless_2009 >= 176 AND total_homeless_2017 < 10956.745762711864)", "https://mlevin.carto.com/api/v2/viz/3bf3cebd-1eb5-4468-b424-94b31dcde9aa/viz.json")
  .done(function(data) {
    console.log(data.rows);
  })
  .error(function(errors) {
    // errors contains a list of errors
    console.log("errors:" + errors);
  })

    cartodb.createLayer(map, {
      user_name: 'mlevin',
      type: 'cartodb',
      sublayers: [{
        sql: "SELECT * FROM homelessness_totals WHERE (total_homeless_2009 >= 176 AND total_homeless_2017 < 10956.745762711864)",
        cartocss: "#homelessness_totals{ polygon-fill: #FFFFB2; polygon-opacity: 0.8; line-color: #FFF; line-width: 0.5; line-opacity: 1; } #homelessness_totals [ cartodb_id2 <= 3145] { polygon-fill: #B10026;} #homelessness_totals [ cartodb_id2 <= 2474] { polygon-fill: #E31A1C; } #homelessness_totals [ cartodb_id2 <= 1934] { polygon-fill: #FC4E2A; } #homelessness_totals [ cartodb_id2 <= 1629] { polygon-fill: #FD8D3C; } #homelessness_totals [ cartodb_id2 <= 1490] { polygon-fill: #FEB24C; }  #homelessness_totals [ cartodb_id2 <= 1179] { polygon-fill: #FED976; } #homelessness_totals [ cartodb_id2 <= 215] { polygon-fill: #FFFFB2; }"
      }]
    })
    .addTo(map)
    .done((layer) => {
      layer.setInteraction(true);
    });
  </script>
</body>
